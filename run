#!/bin/bash

# Default values
DAY=$(date +%-d)  # Current day without leading zero
ACTION="s"        # Default action is solution

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--day)
            DAY="$2"
            shift 2
            ;;
        -a|--action)
            ACTION="$2"
            shift 2
            ;;
        *)
            # Positional arguments
            if [[ -z "${FIRST_ARG:-}" ]]; then
                FIRST_ARG="$1"
            elif [[ -z "${SECOND_ARG:-}" ]]; then
                SECOND_ARG="$1"
            fi
            shift
            ;;
    esac
done

# Use positional arguments if provided
DAY="${FIRST_ARG:-$DAY}"
ACTION="${SECOND_ARG:-$ACTION}"

# Convert action to lowercase
ACTION=$(echo "$ACTION" | tr '[:upper:]' '[:lower:]')

# Construct folder path
FOLDER="solutions/day${DAY}"

# Check if folder exists
if [ ! -d "$FOLDER" ]; then
    echo "Error: Folder '$FOLDER' does not exist"
    exit 1
fi

# Activate virtual environment
if [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
else
    echo "Error: Virtual environment not found at 'venv/bin/activate'"
    exit 1
fi

# Change to the day's folder
cd "$FOLDER" || exit 1

# Run the appropriate command
case $ACTION in
    t|test|tests)
        echo "Running tests for day ${DAY}..."
        python -m tests --verbose
        ;;
    s|solution|sol)
        echo "Running solution for day ${DAY}..."
        python -m solution
        ;;
    *)
        echo "Error: Invalid action '$ACTION'. Use 't' for tests or 's' for solution"
        deactivate
        exit 1
        ;;
esac

# Store exit code
EXIT_CODE=$?

# Deactivate virtual environment
deactivate

# Return to original directory (optional)
cd - > /dev/null

exit $EXIT_CODE